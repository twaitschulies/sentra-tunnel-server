{% extends "base.html" %}

{% block title %}{{ shop.name }} - Sentra Guard{% endblock %}

{% block header %}
<!-- Header -->
<header class="sticky top-0 z-50 bg-white border-b border-gray-200">
    <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <a href="/dashboard"
               class="w-9 h-9 -ml-2 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-smooth">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div>
                <span class="font-semibold text-gray-900">{{ shop.name }}</span>
            </div>
        </div>

        <!-- Lock Icon -->
        <div class="w-9 h-9 flex items-center justify-center">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="shopDashboard()">

    <!-- Tab Navigation -->
    <div class="sticky top-14 z-40 bg-white border-b border-gray-200">
        <div class="px-4 flex space-x-1">
            <button @click="activeTab = 'dashboard'"
                    :class="activeTab === 'dashboard' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-3 text-sm font-medium transition-smooth">
                Dashboard
            </button>
            <button @click="activeTab = 'ueberwachung'"
                    :class="activeTab === 'ueberwachung' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-3 text-sm font-medium transition-smooth">
                Überwachung
            </button>
            <button @click="activeTab = 'service'"
                    :class="activeTab === 'service' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-3 text-sm font-medium transition-smooth">
                Service
            </button>
            <button @click="activeTab = 'geraete'"
                    :class="activeTab === 'geraete' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-3 text-sm font-medium transition-smooth">
                Geräte
            </button>
        </div>
    </div>

    <!-- ==================== ÜBERWACHUNG TAB ==================== -->
    <div x-show="activeTab === 'ueberwachung'" x-cloak class="p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">
            <span class="text-gray-900">Überwachung</span>
            <span class="text-gray-400 font-normal">Standort</span>
        </h2>

        <!-- Sensors List -->
        <div class="mt-6 bg-white rounded-2xl border border-gray-200 divide-y divide-gray-100">
            <!-- Haupteingang -->
            {% for device in devices %}
            <div class="flex items-center justify-between px-4 py-4">
                <span class="text-gray-900">{{ device.name or device.device_id }}</span>
                <span class="px-3 py-1 text-sm rounded-lg border
                            {% if device.online and device.last_status.gpio_state %}
                            bg-green-50 text-green-700 border-green-200
                            {% elif device.online %}
                            bg-gray-50 text-gray-600 border-gray-200
                            {% else %}
                            bg-red-50 text-red-600 border-red-200
                            {% endif %}">
                    {% if device.online %}
                        {% if device.last_status.gpio_state %}Offen{% else %}Geschlossen{% endif %}
                    {% else %}
                        Offline
                    {% endif %}
                </span>
            </div>
            {% endfor %}

            <!-- Demo Sensors (placeholder data) -->
            <div class="flex items-center justify-between px-4 py-4">
                <span class="text-gray-900">Verkaufsraum</span>
                <span class="px-3 py-1 text-sm rounded-lg bg-green-50 text-green-700 border border-green-200">
                    15.88°C
                </span>
            </div>
            <div class="flex items-center justify-between px-4 py-4">
                <span class="text-gray-900">Zwischenlager</span>
                <span class="px-3 py-1 text-sm rounded-lg bg-green-50 text-green-700 border border-green-200">
                    7.69°C
                </span>
            </div>
            <div class="flex items-center justify-between px-4 py-4">
                <span class="text-gray-900">Außenbeleuchtung</span>
                <span class="px-3 py-1 text-sm rounded-lg bg-gray-50 text-gray-600 border border-gray-200">
                    Aus
                </span>
            </div>
        </div>

        <!-- Lighting Controls -->
        <div class="mt-6 bg-white rounded-2xl border border-gray-200 p-4">
            <div class="space-y-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="lightingOptions.openingHours"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Öffnungszeitenabhängig</span>
                        <p class="text-sm text-gray-500">Aktiviert Beleuchtung entsprechend der Geschäftszeiten.</p>
                    </div>
                </label>

                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="lightingOptions.timeControlled" checked
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Zeitgesteuert</span>
                        <p class="text-sm text-gray-500">Deaktiviert Beleuchtung im festgelegten Zeitraum.</p>
                    </div>
                </label>
            </div>

            <!-- Time Slider -->
            <div class="mt-6" x-show="lightingOptions.timeControlled">
                <p class="text-sm text-gray-600 mb-3">Beleuchtung aus von <span class="font-semibold text-red-500" x-text="timeSlider.start + ':00'"></span> bis <span class="font-semibold text-red-500" x-text="timeSlider.end + ':00'"></span></p>

                <div class="relative h-2 bg-gray-200 rounded-full select-none"
                     x-ref="sliderTrack">
                    <!-- Active range -->
                    <div class="absolute h-2 bg-red-400 rounded-full pointer-events-none"
                         :style="'left: ' + sliderStartPercent + '%; width: ' + sliderWidthPercent + '%'"></div>
                    <!-- Start handle -->
                    <div class="absolute w-6 h-6 bg-white border-2 border-red-400 rounded-full -mt-2 cursor-grab active:cursor-grabbing shadow-md hover:scale-110 hover:border-red-500 z-10"
                         :style="'left: calc(' + sliderStartPercent + '% - 12px)'"
                         @mousedown.prevent="startDrag($event, 'start')"
                         @touchstart.prevent="startDrag($event, 'start')"></div>
                    <!-- End handle -->
                    <div class="absolute w-6 h-6 bg-white border-2 border-red-400 rounded-full -mt-2 cursor-grab active:cursor-grabbing shadow-md hover:scale-110 hover:border-red-500 z-10"
                         :style="'left: calc(' + sliderEndPercent + '% - 12px)'"
                         @mousedown.prevent="startDrag($event, 'end')"
                         @touchstart.prevent="startDrag($event, 'end')"></div>
                </div>
                <!-- Time Labels -->
                <div class="flex justify-between mt-3 text-xs text-gray-500">
                    <span>17</span>
                    <span>19</span>
                    <span>21</span>
                    <span>23</span>
                    <span>1</span>
                    <span>3</span>
                    <span>5</span>
                    <span>7</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions for Monitoring -->
        <div class="mt-6 grid grid-cols-2 gap-3">
            <button class="bg-white rounded-xl p-4 border border-gray-200 hover:border-primary hover:shadow-md transition-smooth text-left">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                </div>
                <p class="font-medium text-gray-900">Alarme</p>
                <p class="text-xs text-gray-500">0 aktiv</p>
            </button>

            <button class="bg-white rounded-xl p-4 border border-gray-200 hover:border-primary hover:shadow-md transition-smooth text-left">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mb-2">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <p class="font-medium text-gray-900">Historie</p>
                <p class="text-xs text-gray-500">Letzte 7 Tage</p>
            </button>
        </div>
    </div>

    <!-- ==================== SERVICE TAB ==================== -->
    <div x-show="activeTab === 'service'" x-cloak class="p-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">
                <span class="text-gray-900">Service</span>
                <span class="text-gray-400 font-normal">Liste</span>
            </h2>
            <!-- Toggle -->
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
            </label>
        </div>

        <!-- Quick Action Button -->
        {% if devices %}
        <div class="mb-6">
            <button @click="lockDoor('{{ devices[0].device_id }}', 15)"
                    :disabled="lockingDoor"
                    class="w-full py-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl
                           flex items-center justify-center space-x-3 transition-smooth shadow-md
                           disabled:opacity-50 disabled:cursor-not-allowed">
                <template x-if="lockingDoor">
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </template>
                <template x-if="!lockingDoor && !doorLocked">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </template>
                <template x-if="doorLocked">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </template>
                <span x-text="doorLocked ? 'TÜR GESPERRT' : 'TÜR FÜR 15 MIN SPERREN'"></span>
            </button>
            <!-- Unlock button (shows when door is locked) -->
            <button x-show="doorLocked"
                    @click="unlockDoor('{{ devices[0].device_id }}')"
                    :disabled="lockingDoor"
                    class="w-full mt-2 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl
                           flex items-center justify-center space-x-2 transition-smooth">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                </svg>
                <span>Sperre aufheben</span>
            </button>
        </div>
        {% endif %}

        <!-- Service Checklist -->
        <div class="bg-white rounded-2xl border border-gray-200 divide-y divide-gray-100">
            <!-- Getränkeautomat -->
            <div class="p-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="serviceChecks.kaffee"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Getränkeautomat</span>
                        <ul class="mt-1 text-sm text-gray-500 list-disc list-inside">
                            <li>Zutaten und Becher auffüllen</li>
                            <li>Gerät reinigen</li>
                        </ul>
                    </div>
                </label>
            </div>

            <!-- Milchsystem -->
            <div class="p-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="serviceChecks.milch"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Milchsystem warten</span>
                    </div>
                </label>
            </div>

            <!-- Tägliche Reinigung -->
            <div class="p-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="serviceChecks.reinigung"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Tägliche Reinigung</span>
                        <ul class="mt-1 text-sm text-gray-500 list-disc list-inside">
                            <li>Kassenbereich säubern</li>
                            <li>Utensilien desinfizieren</li>
                            <li>Eingangsbereich reinigen</li>
                            <li>Regale abwischen</li>
                            <li>Böden reinigen</li>
                            <li>Abfall entsorgen</li>
                            <li>Bildschirme reinigen</li>
                            <li>Dampfreinigung (nach Bedarf)</li>
                        </ul>
                    </div>
                </label>
            </div>

            <!-- Bestandskontrolle -->
            <div class="p-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="serviceChecks.kontrolle"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Bestandskontrolle</span>
                        <ul class="mt-1 text-sm text-gray-500 list-disc list-inside">
                            <li>Waren nach vorne sortieren</li>
                            <li>Temperaturregelung prüfen</li>
                            <li>Frischeprodukte kontrollieren</li>
                        </ul>
                    </div>
                </label>
            </div>

            <!-- Lieferungsannahme -->
            <div class="p-4">
                <label class="flex items-start space-x-3 cursor-pointer">
                    <input type="checkbox" x-model="serviceChecks.waren"
                           class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div>
                        <span class="font-medium text-gray-900">Lieferungsannahme</span>
                        <ul class="mt-1 text-sm text-gray-500 list-disc list-inside">
                            <li>Lieferdokumente prüfen</li>
                            <li>Waren verräumen</li>
                            <li>Haltbarkeit kontrollieren</li>
                        </ul>
                    </div>
                </label>
            </div>
        </div>

        <!-- Progress -->
        <div class="mt-6 bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Fortschritt</span>
                <span class="text-sm text-gray-500" x-text="completedTasks + '/' + totalTasks"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all duration-300"
                     :style="'width: ' + (completedTasks / totalTasks * 100) + '%'"></div>
            </div>
        </div>
    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div x-show="activeTab === 'dashboard'" x-cloak class="p-4">
        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span>{{ shop.name }}</span>
            <span class="text-gray-300">></span>
            <span>Startseite</span>
            <span class="text-gray-300">></span>
            <span class="text-gray-900">Übersicht</span>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Umsatz -->
            <div class="bg-gradient-to-br from-cyan-400 to-cyan-500 rounded-2xl p-4 text-white">
                <div class="h-12 mb-2 opacity-60">
                    <svg viewBox="0 0 100 40" class="w-full h-full">
                        <polyline fill="none" stroke="currentColor" stroke-width="2"
                                  points="0,30 20,25 40,28 60,15 80,20 100,10"/>
                    </svg>
                </div>
                <p class="text-sm opacity-80">Umsatz</p>
                <p class="text-2xl font-bold">€ 532,22</p>
                <p class="text-xs opacity-70 flex items-center mt-1">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                    -52% vom Durchschnitt
                </p>
            </div>

            <!-- Bestellungen -->
            <div class="bg-gradient-to-br from-green-400 to-green-500 rounded-2xl p-4 text-white">
                <div class="h-12 mb-2 opacity-60">
                    <svg viewBox="0 0 100 40" class="w-full h-full">
                        <polyline fill="none" stroke="currentColor" stroke-width="2"
                                  points="0,35 25,30 50,25 75,28 100,20"/>
                    </svg>
                </div>
                <p class="text-sm opacity-80">Bestellungen</p>
                <p class="text-2xl font-bold">86</p>
                <p class="text-xs opacity-70 flex items-center mt-1">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                    -50% vom Durchschnitt
                </p>
            </div>

            <!-- Kassenstand -->
            <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-4 text-white">
                <div class="h-12 mb-2 flex items-center justify-center opacity-60">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-sm opacity-80">Kassenstand</p>
                <p class="text-2xl font-bold">€ 1.044,12</p>
            </div>

            <!-- Stammkunden -->
            <div class="bg-gradient-to-br from-purple-400 to-purple-500 rounded-2xl p-4 text-white">
                <div class="h-12 mb-2 opacity-60">
                    <svg viewBox="0 0 100 40" class="w-full h-full">
                        <polyline fill="none" stroke="currentColor" stroke-width="2"
                                  points="0,30 30,25 60,30 100,15"/>
                    </svg>
                </div>
                <p class="text-sm opacity-80">Stammkunden</p>
                <p class="text-2xl font-bold">38</p>
                <p class="text-xs opacity-70 flex items-center mt-1">
                    <svg class="w-3 h-3 mr-1 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                    -12% vom Durchschnitt
                </p>
            </div>
        </div>

        <!-- Recent Orders and Chat -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Orders Table -->
            <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">Die letzten <span class="text-primary">15</span> Bestellungen</h3>
                </div>
                <div class="px-4 py-2 bg-gray-50 text-center text-sm text-gray-500">
                    Nächste Aktualisierung in 8:01 Minuten
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="px-4 py-3 text-left">Datum</th>
                                <th class="px-4 py-3 text-left">Kunde</th>
                                <th class="px-4 py-3 text-left">Zahlungsmethode</th>
                                <th class="px-4 py-3 text-left">Summe</th>
                                <th class="px-4 py-3 text-left">Bewertung</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-600">29.11.2021 13:11 Uhr</td>
                                <td class="px-4 py-3 text-sm text-gray-400">---</td>
                                <td class="px-4 py-3 text-sm text-gray-600">Barzahlung</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">€ 11,20</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-500 rounded">Keine</span>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-600">29.11.2021 13:08 Uhr</td>
                                <td class="px-4 py-3 text-sm text-gray-400">---</td>
                                <td class="px-4 py-3 text-sm text-gray-600">Kredit-/Debitkarte</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">€ 4,23</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-500 rounded">Keine</span>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-600">29.11.2021 12:45 Uhr</td>
                                <td class="px-4 py-3 text-sm text-gray-400">---</td>
                                <td class="px-4 py-3 text-sm text-gray-600">Barzahlung</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">€ 8,50</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs bg-green-100 text-green-600 rounded">5 ★</span>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-600">29.11.2021 12:30 Uhr</td>
                                <td class="px-4 py-3 text-sm text-gray-600">Stammkunde #12</td>
                                <td class="px-4 py-3 text-sm text-gray-600">Kredit-/Debitkarte</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">€ 15,80</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-500 rounded">Keine</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User & Chat Panel -->
            <div class="space-y-4">
                <!-- User Info -->
                <div class="bg-white rounded-2xl border border-gray-200 p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-primary to-primary-hover rounded-full flex items-center justify-center text-white font-semibold">
                            {{ user.username[:2]|upper }}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">{{ user.username }}</p>
                            <p class="text-sm text-gray-500">{{ user.role|capitalize }}</p>
                        </div>
                    </div>
                </div>

                <!-- Chat/Messages -->
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-100">
                        <h4 class="font-medium text-gray-900">Nachrichten</h4>
                    </div>
                    <div class="p-4 space-y-3 max-h-64 overflow-y-auto">
                        <div class="flex items-start space-x-2">
                            <div class="flex-1">
                                <p class="text-xs text-gray-400">13:39:28 Uhr <span class="font-medium text-gray-600">Terminal</span></p>
                                <div class="mt-1 bg-green-100 text-green-800 rounded-lg px-3 py-2 text-sm inline-block">
                                    Hallo, ich bin bereit Nachrichten zu empfangen...
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="flex-1">
                                <p class="text-xs text-gray-400">13:35:12 Uhr <span class="font-medium text-gray-600">System</span></p>
                                <div class="mt-1 bg-blue-100 text-blue-800 rounded-lg px-3 py-2 text-sm inline-block">
                                    Tagesabschluss erfolgreich durchgeführt.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="px-4 py-3 border-t border-gray-100">
                        <div class="flex space-x-2">
                            <input type="text" placeholder="Nachricht eingeben..."
                                   class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <button class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-hover transition-smooth">
                                Senden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== GERÄTE TAB ==================== -->
    <div x-show="activeTab === 'geraete'" x-cloak class="p-4">
        {% if devices %}
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-2xl border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium uppercase">Online</p>
                        <p class="text-2xl font-bold text-success mt-1">{{ devices|selectattr('online')|list|length }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium uppercase">Gesamt</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ devices|length }}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Cards -->
        <div class="space-y-4">
            {% for device in devices %}
            <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:shadow-md transition-smooth"
                 :class="{ 'ring-2 ring-success': success['{{ device.device_id }}'] }">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center
                                        {% if device.online %}bg-green-100{% else %}bg-gray-100{% endif %}">
                                <svg class="w-6 h-6 {% if device.online %}text-success{% else %}text-gray-400{% endif %}"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">{{ device.name or device.device_id }}</h3>
                                <p class="text-xs text-gray-500">
                                    {% if device.online %}
                                        {% if device.last_status.gpio_state %}Offen{% else %}Geschlossen{% endif %}
                                        · {{ device.last_status.current_mode | default('Normal') }}
                                    {% else %}
                                        Offline
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-2 h-2 rounded-full {% if device.online %}bg-success{% else %}bg-gray-300{% endif %}"></span>
                            <a href="/device/{{ device.device_id }}" class="text-sm text-primary hover:underline">Details</a>
                        </div>
                    </div>
                </div>

                {% if can_control %}
                <div class="px-4 pb-4">
                    {% if device.online %}
                    <button @click="openDoor('{{ device.device_id }}')"
                            :disabled="loading['{{ device.device_id }}']"
                            class="w-full py-3 bg-primary hover:bg-primary-hover text-white font-medium rounded-xl
                                   disabled:opacity-50 transition-smooth flex items-center justify-center space-x-2">
                        <template x-if="loading['{{ device.device_id }}']">
                            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                            </svg>
                        </template>
                        <template x-if="success['{{ device.device_id }}']">
                            <span>✓ Erfolgreich</span>
                        </template>
                        <template x-if="!loading['{{ device.device_id }}'] && !success['{{ device.device_id }}']">
                            <span>Tür öffnen</span>
                        </template>
                    </button>
                    {% else %}
                    <button disabled class="w-full py-3 bg-gray-100 text-gray-400 font-medium rounded-xl cursor-not-allowed">
                        Gerät offline
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-1">Keine Geräte</h3>
            <p class="text-gray-500">In diesem Shop sind noch keine Geräte registriert.</p>
        </div>
        {% endif %}

        {% if user.role == 'admin' %}
        <!-- Add Device FAB -->
        <button @click="showAddDevice = true"
                class="fixed bottom-6 right-6 w-14 h-14 bg-primary hover:bg-primary-hover text-white rounded-full shadow-lg
                       flex items-center justify-center transition-smooth hover:scale-105">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
        </button>
        {% endif %}
    </div>

    {% if user.role == 'admin' %}
    <!-- Add Device Modal -->
    <div x-show="showAddDevice" x-cloak
         class="fixed inset-0 z-50 flex items-end sm:items-center justify-center"
         @keydown.escape.window="showAddDevice = false">
        <div class="absolute inset-0 bg-black/50" @click="showAddDevice = false"></div>
        <div class="relative bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Neues Gerät</h3>
                <button @click="showAddDevice = false" class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form action="/admin/device/create" method="POST">
                <input type="hidden" name="shop_id" value="{{ shop_id }}">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gerätename</label>
                    <input type="text" name="device_name" required placeholder="z.B. Haupteingang"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
                <button type="submit" class="w-full py-3 bg-primary text-white font-medium rounded-xl hover:bg-primary-hover transition-smooth">
                    Token erstellen
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
function shopDashboard() {
    return {
        activeTab: 'dashboard',
        loading: {},
        success: {},
        showAddDevice: false,
        lockingDoor: false,
        doorLocked: false,
        serviceChecks: {
            kaffee: false,
            milch: false,
            reinigung: false,
            kontrolle: false,
            waren: false
        },
        lightingOptions: {
            openingHours: false,
            timeControlled: true
        },
        timeSlider: {
            start: 23,
            end: 4
        },

        // Time slider spans 17-7 (15 hours, wrapping through midnight)
        // We map this to 0-100%
        timeToPercent(hour) {
            // 17 = 0%, 7 = 100% (15 hour range: 17,18,19,20,21,22,23,0,1,2,3,4,5,6,7)
            let adjusted = hour >= 17 ? hour - 17 : hour + 7;
            return (adjusted / 14) * 100;
        },

        percentToTime(percent) {
            let adjusted = Math.round((percent / 100) * 14);
            let hour = adjusted < 7 ? adjusted + 17 : adjusted - 7;
            if (hour >= 24) hour -= 24;
            return hour;
        },

        get sliderStartPercent() {
            return this.timeToPercent(this.timeSlider.start);
        },

        get sliderEndPercent() {
            return this.timeToPercent(this.timeSlider.end);
        },

        get sliderWidthPercent() {
            let start = this.sliderStartPercent;
            let end = this.sliderEndPercent;
            if (end < start) {
                return (100 - start) + end;
            }
            return end - start;
        },

        get totalTasks() {
            return Object.keys(this.serviceChecks).length;
        },

        get completedTasks() {
            return Object.values(this.serviceChecks).filter(v => v).length;
        },

        startDrag(event, handle) {
            const track = this.$refs.sliderTrack;
            const rect = track.getBoundingClientRect();

            const updatePosition = (clientX) => {
                const percent = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
                const hour = this.percentToTime(percent);

                if (handle === 'start') {
                    this.timeSlider.start = hour;
                } else if (handle === 'end') {
                    this.timeSlider.end = hour;
                }
            };

            const onMove = (e) => {
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                updatePosition(clientX);
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onEnd);
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', onEnd);
        },

        async openDoor(deviceId) {
            this.loading[deviceId] = true;
            this.success[deviceId] = false;

            try {
                const response = await fetch(`/api/commands/${deviceId}/open`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    this.success[deviceId] = true;
                    setTimeout(() => { this.success[deviceId] = false; }, 2000);
                } else {
                    alert(data.error || 'Fehler beim Öffnen');
                }
            } catch (e) {
                alert('Verbindungsfehler');
            } finally {
                this.loading[deviceId] = false;
            }
        },

        async lockDoor(deviceId, minutes) {
            this.lockingDoor = true;

            try {
                const durationHours = minutes / 60;  // Convert minutes to hours
                const response = await fetch(`/api/commands/${deviceId}/override?mode=access_blocked&duration_hours=${durationHours}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    this.doorLocked = true;
                    // Auto-reset after duration
                    setTimeout(() => {
                        this.doorLocked = false;
                    }, minutes * 60 * 1000);
                } else {
                    alert(data.error || 'Fehler beim Sperren der Tür');
                }
            } catch (e) {
                console.error('Lock door error:', e);
                alert('Verbindungsfehler');
            } finally {
                this.lockingDoor = false;
            }
        },

        async unlockDoor(deviceId) {
            this.lockingDoor = true;

            try {
                const response = await fetch(`/api/commands/${deviceId}/override`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    this.doorLocked = false;
                } else {
                    alert(data.error || 'Fehler beim Entsperren');
                }
            } catch (e) {
                console.error('Unlock door error:', e);
                alert('Verbindungsfehler');
            } finally {
                this.lockingDoor = false;
            }
        }
    }
}
</script>
{% endblock %}
